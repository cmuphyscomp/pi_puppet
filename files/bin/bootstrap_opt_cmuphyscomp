#!/bin/bash

# This is a rarely-used and fragile script to create from scratch the bulk of
# the Raspberry Pi courseware tree for the Intro to Physical Computing course in
# IDeATe at Carnegie Mellon University.

# The courseware is stored under /opt/cmuphyscomp.  The puppet system creates
# symbolic links to these files in various places around the system.

# The courseware includes several repository checkouts and a few local
# compilations to allow the possibility of updating parts of it in place.

# This script has minimal error-checking and should be run with caution.

# Check whether the folder already exists.
if [ -e "/opt/cmuphyscomp" ];
then
    echo "/opt/cmuphyscomp already exists, quitting without action."
    exit 0;
fi


# Check whether we are root, in order to get correct permissions locally.
if [ `whoami` != "root" ];
then
    echo "This must be run as root in order to create correct permissions."
    exit 0;
fi

# The following sequence will need to be kept up to date, and is likely to break!

echo "Creating folders in /opt/cmuphyscomp."
mkdir /opt/cmuphyscomp
mkdir /opt/cmuphyscomp/lib
mkdir /opt/cmuphyscomp/lib/pd-externals
mkdir /opt/cmuphyscomp/src

echo "Checking out and building Pd externals."
cd /opt/cmuphyscomp/src
svn checkout -N svn://svn.code.sf.net/p/pure-data/svn/trunk pd-svn
cd pd-svn 
svn update -N externals
svn update -N packages
svn update -N pd
cd pd
svn update -N src
cd ..
cd externals 
svn up mrpeach
cd /opt/cmuphyscomp/src/pd-svn/externals
make mrpeach
mkdir /opt/cmuphyscomp/lib/pd-externals/mrpeach
install -p mrpeach/*/*.pd_linux mrpeach/*/*.pd /opt/cmuphyscomp/lib/pd-externals/mrpeach

echo "Cloning OSC libraries from github."
cd /opt/cmuphyscomp/src
git clone https://github.com/CNMAT/OSC

echo "Cloning course materials from github."
cd /opt/cmuphyscomp
git clone https://github.com/cmuphyscomp/course-demos.git

echo "Cloning wiringPi from git.drogon.net, building, and installing."
cd /opt/cmuphyscomp/src
git clone git://git.drogon.net/wiringPi
cd wiringPi
./build

echo "Note: wiringPi installs files into /usr/local"
